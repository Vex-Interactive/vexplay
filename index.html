<html lang="en">
    <head>
        <!-- Vercel Analytics and Speed Insights -->
        <script defer src="/_vercel/insights/script.js"></script>
        <script defer src="/_vercel/speed-insights/script.js"></script>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-NX2QKP76"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-7FN7LEVWXD');
        </script>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="/images/ico.ico" type="image/x-icon">
        <link rel="stylesheet" href="/storage/css/index.css">
        <title>Home | Vexplay</title>

        <meta name="description" content="an open source games site hosting 500+ games, useful utilities, powerful settings + a clean user interface">
        <meta property="og:site_name" content="Vexplay">
        <meta property="og:title" content="Vexplay">
        <meta property="og:type" content="website">
        <meta property="og:description" content="an open source games site hosting 500+ games, useful utilities, powerful settings + a clean user interface">
        
        <style>
            .login-button {
                display: none;
                margin-top: 15px;
                padding: 10px 20px;
                background-color: var(--background-color);
                color: var(--text-color);
                border: 3px solid var(--border-color2);
                border-radius: 12px;
                font-size: 18px;
                cursor: pointer;
                font-family: var(--font-family);
                transition: background-color 0.15s ease-in-out;
            }
            
            .login-button:hover {
                background-color: var(--hover-color);
            }
            
            .auth-status {
                margin-top: 10px;
                font-size: 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }
            
            .auth-status button {
                padding: 5px 10px;
                background-color: var(--background-color);
                color: var(--text-color);
                border: 2px solid var(--border-color2);
                border-radius: 8px;
                cursor: pointer;
                font-family: var(--font-family);
                transition: background-color 0.15s ease-in-out;
            }
            
            .auth-status button:hover {
                background-color: var(--hover-color);
            }
            
            .guest-badge {
                display: inline-block;
                padding: 3px 8px;
                background-color: var(--border-color2);
                border-radius: 8px;
                font-size: 14px;
                margin-left: 5px;
            }
            
            /* Search icon and search modal styles */
            .search-icon {
                position: fixed;
                top: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                background-color: var(--primary-color, #4a90e2);
                border: 2px solid var(--border-color2);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                z-index: 100;
                transition: all 0.2s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            }
            
            .search-icon:hover {
                background-color: var(--hover-color);
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
            }
            
            .search-icon svg {
                width: 24px;
                height: 24px;
                fill: white;
            }
            
            .search-shortcut {
                position: absolute;
                bottom: -18px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 10px;
                white-space: nowrap;
                opacity: 0;
                transition: opacity 0.2s;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            }
            
            .search-icon:hover .search-shortcut {
                opacity: 1;
            }
            
            .search-modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.85);
                z-index: 1000;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(6px);
            }
            
            .search-container {
                width: 90%;
                max-width: 600px;
                background-color: rgba(15, 15, 15, 0.95);
                border: 3px solid var(--border-color2);
                border-radius: 16px;
                padding: 25px;
                position: relative;
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .search-close {
                position: absolute;
                top: 15px;
                right: 15px;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 50%;
                border: none;
                color: var(--text-color);
                font-size: 20px;
                transition: all 0.2s;
            }
            
            .search-close:hover {
                background: rgba(255, 0, 0, 0.3);
                transform: scale(1.1);
                color: white;
            }
            
            .search-header {
                text-align: center;
                margin-bottom: 20px;
            }
            
            .search-header h2 {
                color: white;
                font-size: 28px;
                margin: 0;
                text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            }
            
            .search-input-container {
                display: flex;
                margin-bottom: 20px;
            }
            
            .search-input {
                flex: 1;
                padding: 14px 18px;
                border: 2px solid var(--border-color2);
                border-radius: 10px;
                font-size: 16px;
                background-color: rgba(0, 0, 0, 0.3);
                color: white;
                margin-right: 10px;
                transition: all 0.3s ease;
                box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
            }
            
            .search-input:focus {
                border-color: var(--primary-color, #4a90e2);
                box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3), inset 0 2px 5px rgba(0, 0, 0, 0.2);
                outline: none;
            }
            
            .search-input::placeholder {
                color: rgba(255, 255, 255, 0.6);
            }
            
            .search-button {
                padding: 0 25px;
                background-color: var(--primary-color, #4a90e2);
                color: white;
                border: 2px solid var(--border-color2);
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: bold;
                font-size: 16px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }
            
            .search-button:hover {
                background-color: var(--hover-color);
                transform: translateY(-3px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            }
            
            .search-tabs {
                display: flex;
                border-bottom: 2px solid var(--border-color2);
                margin-bottom: 15px;
                padding-bottom: 5px;
            }
            
            .search-tab {
                padding: 10px 20px;
                cursor: pointer;
                border-bottom: 3px solid transparent;
                transition: all 0.3s;
                margin-right: 5px;
                color: rgba(255, 255, 255, 0.7);
                font-size: 16px;
                border-radius: 5px 5px 0 0;
            }
            
            .search-tab:hover {
                color: white;
                background-color: rgba(255, 255, 255, 0.05);
            }
            
            .search-tab.active {
                border-bottom: 3px solid var(--primary-color, #4a90e2);
                font-weight: bold;
                color: white;
            }
            
            .search-results {
                max-height: 50vh;
                overflow-y: auto;
                padding: 15px;
                border-radius: 10px;
                background-color: rgba(0, 0, 0, 0.2);
                scrollbar-width: thin;
                scrollbar-color: var(--primary-color) rgba(0,0,0,0.2);
            }
            
            .search-results::-webkit-scrollbar {
                width: 8px;
            }
            
            .search-results::-webkit-scrollbar-track {
                background: rgba(0,0,0,0.1);
                border-radius: 10px;
            }
            
            .search-results::-webkit-scrollbar-thumb {
                background-color: var(--primary-color);
                border-radius: 10px;
            }
            
            .search-result-item {
                padding: 15px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                cursor: pointer;
                display: flex;
                align-items: center;
                transition: all 0.3s ease;
                border-radius: 8px;
                margin-bottom: 10px;
                background-color: rgba(255, 255, 255, 0.05);
            }
            
            .search-result-item:hover {
                background-color: rgba(255, 255, 255, 0.1);
                transform: translateX(5px) scale(1.01);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }
            
            .search-result-item img {
                width: 50px;
                height: 50px;
                border-radius: 8px;
                margin-right: 15px;
                object-fit: cover;
                border: 2px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            }
            
            .user-result-avatar {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                margin-right: 15px;
                background-size: cover;
                background-position: center;
                background-color: var(--border-color2);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                font-size: 20px;
                border: 2px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            }
            
            .search-result-info {
                flex: 1;
            }
            
            .search-result-title {
                font-weight: bold;
                margin-bottom: 5px;
                font-size: 16px;
                color: white;
            }
            
            .search-result-description {
                font-size: 14px;
                opacity: 0.8;
                line-height: 1.4;
                color: rgba(255, 255, 255, 0.8);
            }
            
            .search-no-results {
                text-align: center;
                padding: 25px;
                color: rgba(255, 255, 255, 0.6);
                border-radius: 10px;
                background-color: rgba(0, 0, 0, 0.2);
                margin: 10px 0;
                font-size: 16px;
            }
        </style>
  </head>
  <body>
    
     <div id="blackout"></div>
     <div id="updPopup">
        <img src="/images/other/v10image.jpg" style="width: 90%;">
        <br><br>
        <h2 style="font-size: 28px; text-decoration: underline;">version 13 / patch notes</h2>

        <div id="updContent">
            <ul style="text-align: left;">
                <li>authentication
                  <ul>
                    <li>removed phone authentication</li>
                    <li>added password reset functionality</li>
                    <li>all games are free for guests. apps locked behind login.</li>
                  </ul>
                </li>
                <li>features
                  <ul>
                    <li>added a real-time chat system</li>
                    <li>added emoji support in chat</li>
                    <li>added online user tracking</li>
                  </ul>
                </li>
                <li>analytics
                  <ul>
                    <li>integrated Vercel Analytics and Speed Insights</li>
                    <li>improved performance monitoring</li>
                  </ul>
                </li>
                <li>general
                  <ul>
                    <li>added and updated requested games</li>
                    <li>11 bugs patched</li>
                  </ul>
                </li>
              </ul>        
        </div>
        <div id="updConfirmFrame"><button id="updConfirm">okay</button></div>
      </div>

      
      <div class="content-side">
          <h1 class="typewriter"><span id="cursor"></span></h1>
          <h2>version 13 / release build</h2>
          <br>

          <div class="button-container">
              <div class="gamesbutton" onclick="window.location='games/index.html';">
                  <img src="images/other/controller.png">
                  <div class="button-text">
                      <p>games</p>
                  </div>
              </div>
          
              <div class="gamesbutton" onclick="window.location='apps/index.html';">
                  <a href="apps/index.html"><img src="images/other/apps.png"></a>
                  <div class="button-text">
                      <p>apps</p>
                  </div>
              </div>

              <div class="gamesbutton" onclick="window.location='settings.html';">
                <a href="settings.html"><img src="images/other/settings.png"></a>
                <div class="button-text">
                    <p>settings</p>
                </div>
            </div>

              <div class="gamesbutton" onclick="window.location='chat.html';">
                <img src="images/other/chat.png" onerror="this.src='images/other/settings.png';" style="filter: hue-rotate(120deg);">
                <div class="button-text">
                    <p>chat</p>
                </div>
              </div>
              
              <div id="accountButton" class="gamesbutton" onclick="window.location='account.html';" style="display: none;">
                <a href="account.html"><img src="images/other/user.png" alt="Account" onerror="this.src='images/other/user.png';" onload="this.src='images/other/user.png';"></a>
                <div class="button-text">
                    <p>account</p>
                </div>
              </div>
          </div>
          
          <button id="loginSignupButton" class="login-button" onclick="window.location.href='login.html';">Login / Sign Up</button>
          
          <div id="authStatus" class="auth-status"></div>

          <br>

          <p class="linkp"><a href="/vexplaymob/index.html">mobile</a>  • <a id="openBlankLink">open blank</a> • <a href="login.html" id="loginLink">login / signup</a></p>
          <p class="linkp"><a href="https://discord.gg/k9MH6Y875s" target="_blank">discord</a> • <a href="updatelog.html">update log</a> • <a href="tos.html" target="_blank">terms of service</a> • <a href="pp.html">privacy policy</a></p>
          
          <br>
          <a href="https://github.com/Vex-Interactive" target="_blank" style="text-decoration: none;">website created/developed by Vex-Interractive</a>
        
      </div>

      <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/offline-worker.js').then(function(registration) {
                    console.log('service worker initalised! scope:', registration.scope);
        
                    navigator.serviceWorker.addEventListener('message', function(event) {
                        if (event.data === 'cached') {
                            document.getElementById('cache-status').style.display = 'block';
                        }
                    });
                }, function(error) {
                    console.log('ack, error with serviceworker! ', error);
                });
            });
        }

      </script>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (!localStorage.getItem('v12.1-update')) {
                document.getElementById('blackout').style.display = 'block';
                document.getElementById('updPopup').style.display = 'block';
                localStorage.setItem('v12.1-update', 'true');
            }
            document.getElementById('updConfirm').addEventListener('click', function () {
                document.getElementById('blackout').style.display = 'none';
                document.getElementById('updPopup').style.display = 'none';
            });

            // Authentication UI updates
            const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
            const isGuest = localStorage.getItem('isGuest') === 'true';
            const userEmail = localStorage.getItem('userEmail');
            const displayName = localStorage.getItem('displayName');
            
            // Run account migration for existing users
            if (isLoggedIn && !isGuest && !displayName) {
                // Wait for Firebase to initialize
                const checkFirebase = setInterval(function() {
                    if (typeof firebase !== 'undefined' && typeof firebase.firestore === 'function') {
                        clearInterval(checkFirebase);
                        console.log("Firebase ready, running account migration");
                        // Import auth.js functions
                        if (typeof migrateAccount === 'function') {
                            migrateAccount();
                        } else {
                            console.warn("migrateAccount function not found, using inline migration");
                            // Inline migration as fallback
                            const userId = localStorage.getItem('userId');
                            const defaultDisplayName = userEmail.split('@')[0];
                            
                            if (userId && userEmail) {
                                firebase.firestore().collection('userProfiles').doc(userId).set({
                                    displayName: defaultDisplayName,
                                    avatarUrl: '',
                                    setupComplete: true,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    migrationSource: 'inline_migration'
                                }, { merge: true })
                                .then(() => {
                                    localStorage.setItem('displayName', defaultDisplayName);
                                    console.log("Inline migration complete");
                                    updateAuthDisplay(); // Update UI after migration
                                })
                                .catch(error => console.error("Migration error:", error));
                            }
                        }
                    }
                }, 500);
                
                // Stop checking after 10 seconds to avoid infinite loop
                setTimeout(function() {
                    clearInterval(checkFirebase);
                }, 10000);
            }
            
            // Function to update auth display
            function updateAuthDisplay() {
                const loginSignupButton = document.getElementById('loginSignupButton');
                const loginLink = document.getElementById('loginLink');
                const authStatus = document.getElementById('authStatus');
                const accountButton = document.getElementById('accountButton');
                const currentDisplayName = localStorage.getItem('displayName');
                
                if (isLoggedIn) {
                    // User is logged in - show auth status and hide login buttons
                    if (loginLink) loginLink.style.display = 'none';
                    if (loginSignupButton) loginSignupButton.style.display = 'none';
                    
                    // Show account button only for registered users, not guests
                    if (accountButton) {
                        accountButton.style.display = isGuest ? 'none' : 'flex';
                        
                        // REMOVED: Do not update account button avatar
                        // Always keep the default user.png icon
                    }
                    
                    // Show auth status message
                    if (authStatus) {
                        if (isGuest) {
                            authStatus.innerHTML = `
                                <span>Logged in as <strong>Guest</strong> <span class="guest-badge">Limited Access</span></span>
                                <button id="upgradeAccountBtn">Upgrade</button>
                                <button id="logoutBtn">Logout</button>
                            `;
                            
                            // Add event listener for upgrade button
                            document.getElementById('upgradeAccountBtn').addEventListener('click', function() {
                                window.location.href = 'signup.html';
                            });
                        } else {
                            // Use display name if available, otherwise use email
                            const userDisplayName = currentDisplayName || (userEmail ? userEmail.split('@')[0] : 'User');
                            
                            authStatus.innerHTML = `
                                <span>Logged in as <strong>${userDisplayName}</strong></span>
                                <button id="logoutBtn">Logout</button>
                            `;
                        }
                        
                        // Add event listener for logout button
                        document.getElementById('logoutBtn').addEventListener('click', function() {
                            localStorage.removeItem('userLoggedIn');
                            localStorage.removeItem('userEmail');
                            localStorage.removeItem('userId');
                            localStorage.removeItem('isGuest');
                            localStorage.removeItem('displayName');
                            localStorage.removeItem('avatarUrl');
                            window.location.reload();
                        });
                    }
                } else {
                    // User is not logged in - show login button
                    if (loginSignupButton) loginSignupButton.style.display = 'block';
                    if (authStatus) authStatus.style.display = 'none';
                    if (accountButton) accountButton.style.display = 'none';
                }
            }
            
            // Initial UI update
            updateAuthDisplay();
        });
      </script>
      <script>
        const text = "Vexplay";
        const typingDelay = 500; 
        const initialDelay = 100; 
        const cursor = document.getElementById("cursor");
        const h1 = document.querySelector(".typewriter");

        function type() {
            setTimeout(() => {
                for (let i = 0; i < text.length; i++) {
                setTimeout(() => {
                    h1.textContent += text[i];
                    if (i === text.length - 1) {
                    cursor.style.display = "none"; 
                    }
                }, i * typingDelay);
                }
            }, initialDelay);
        }

        type();
      </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var openBlankLink = document.getElementById('openBlankLink');
        
            openBlankLink.addEventListener('click', function(event) {
                event.preventDefault();
        
                var newTab = window.open('about:blank', '_blank');
        
                if (newTab) {
                    var newTabBody = newTab.document.body;
                    newTabBody.style.padding = '0';
                    newTabBody.style.margin = '0';
                    newTabBody.style.border = 'hidden';
        
                    var iframe = document.createElement('iframe');
                    iframe.src = window.location.href;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'hidden';

                    iframe.onload = function() {
                        var links = iframe.contentDocument.querySelectorAll('a[target="_blank"]');
                        links.forEach(function(link) {
                            link.addEventListener('click', function(event) {
                                event.preventDefault();
                                iframe.contentWindow.location.href = link.href;
                            });
                        });
                    };
        
                    newTab.document.body.appendChild(iframe);
                } else {
                    alert("couldn't manage to open a new tab :(");
                }
            });
        });
        </script>    

      <script src="storage/js/cloak.js"></script>
      <script src="storage/js/theme.js"></script>
      <script src="storage/js/cookie.js"></script>
      <script src="storage/js/auth.js"></script>
      
      <!-- Set cosmic theme explicitly -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Force cosmic theme on index page to match other pages
          localStorage.setItem('selectedTheme', 'cosmic');
          document.documentElement.className = 'theme-cosmic';
        });
      </script>
      
      <!-- Firebase SDK -->
      <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-auth-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore-compat.js"></script>
      
      <script>
        // Initialize Firebase if not already initialized
        function initializeFirebase() {
          if (typeof firebase === 'undefined' || !firebase.apps || !firebase.apps.length) {
            const firebaseConfig = {
                apiKey: "AIzaSyBrD_IAs4WIf4ikI-9jdwgH65gXErj8Dv8",
                authDomain: "vexplay-33e9f.firebaseapp.com",
                projectId: "vexplay-33e9f",
                storageBucket: "vexplay-33e9f.firebasestorage.app",
                messagingSenderId: "797854431681",
                appId: "1:797854431681:web:b09b88437937b9fc551740",
                measurementId: "G-KRWYW4Z4Y3"
            };
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
          } else {
            console.log("Firebase already initialized");
          }
          
          // Check if the migration script should run
          checkAndRunMigration();
        }
        
        // Function to check if migration is needed and run it
        function checkAndRunMigration() {
          const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
          const isGuest = localStorage.getItem('isGuest') === 'true';
          const displayName = localStorage.getItem('displayName');
          
          if (isLoggedIn && !isGuest && !displayName) {
            console.log("Migration needed, running migration function");
            // Check if auth.js migration function is available
            if (typeof migrateAccount === 'function') {
              console.log("Using auth.js migrateAccount function");
              migrateAccount();
            } else {
              console.log("Migration function not available, performing inline migration");
              // Fallback to inline migration
              inlineMigration();
            }
          } else if (isLoggedIn && !isGuest) {
            // If user is logged in and not a guest, check if they need to complete setup
            checkAccountSetup();
          } else {
            console.log("No migration needed");
          }
        }
        
        // Function to check if user has completed account setup
        function checkAccountSetup() {
          const userId = localStorage.getItem('userId');
          if (!userId) return;
          
          console.log("Checking if user has completed account setup");
          
          if (typeof firebase !== 'undefined' && typeof firebase.firestore === 'function') {
            firebase.firestore().collection('userProfiles').doc(userId).get()
              .then((doc) => {
                if (doc.exists) {
                  // If setupComplete is false or doesn't exist, redirect to setup
                  if (!doc.data().setupComplete) {
                    console.log("User needs to complete account setup");
                    window.location.href = 'account-setup.html';
                  }
                } else {
                  // No profile document exists, user needs to complete setup
                  console.log("No user profile found, user needs to complete setup");
                  window.location.href = 'account-setup.html';
                }
              })
              .catch(error => {
                console.error("Error checking account setup:", error);
              });
          }
        }
        
        // Fallback inline migration function
        function inlineMigration() {
          const userId = localStorage.getItem('userId');
          const userEmail = localStorage.getItem('userEmail');
          
          if (!userId || !userEmail) {
            console.error("User ID or email missing for inline migration");
            return;
          }
          
          // Create default display name
          const defaultDisplayName = userEmail.split('@')[0];
          localStorage.setItem('displayName', defaultDisplayName);
          
          // Try to save to Firestore if available
          if (typeof firebase !== 'undefined' && typeof firebase.firestore === 'function') {
            firebase.firestore().collection('userProfiles').doc(userId).set({
              displayName: defaultDisplayName,
              avatarUrl: '',
              setupComplete: true,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
              migrationSource: 'inline_index_migration'
            }, { merge: true })
            .then(() => {
              console.log("Inline migration complete");
              // Update the UI after migration
              if (typeof updateAuthDisplay === 'function') {
                updateAuthDisplay();
              }
            })
            .catch(error => {
              console.error("Inline migration error:", error);
              // Still keep the display name in localStorage for UI
            });
          }
        }
        
        // Load Firebase and other scripts
        document.addEventListener('DOMContentLoaded', function() {
          // Initialize Firebase
          initializeFirebase();
        });
      </script>

      <script>
        function displayMessage(message, currentUserId) {
            // Skip if message element already exists
            const messageId = `msg-${message.id}`;
            if (document.getElementById(messageId)) return;

            // Only display if timestamp is a Firestore Timestamp object
            if (!message.timestamp || !message.timestamp.toDate) return;

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(message.senderId === currentUserId ? 'sent' : 'received');
            messageElement.id = messageId;

            const senderElement = document.createElement('div');
            senderElement.classList.add('sender');
            senderElement.textContent = message.sender;

            const textElement = document.createElement('div');
            textElement.textContent = message.text;

            const timeElement = document.createElement('div');
            timeElement.classList.add('time');
            timeElement.textContent = new Date(message.timestamp.toDate()).toLocaleTimeString();

            messageElement.appendChild(senderElement);
            messageElement.appendChild(textElement);
            messageElement.appendChild(timeElement);

            // Add message to the chat
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      </script>

      <!-- Search Icon -->
      <div class="search-icon" id="searchIcon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
          <span class="search-shortcut">Press / to search</span>
      </div>
      
      <!-- Search Modal -->
      <div class="search-modal" id="searchModal">
          <div class="search-container">
              <button class="search-close" id="searchClose">&times;</button>
              <div class="search-header">
                  <h2>Search Vexplay</h2>
              </div>
              <div class="search-input-container">
                  <input type="text" class="search-input" id="searchInput" placeholder="Search for games, apps, or users...">
                  <button class="search-button" id="searchButton">Search</button>
              </div>
              <div class="search-tabs">
                  <div class="search-tab active" data-tab="games">Games</div>
                  <div class="search-tab" data-tab="apps">Apps</div>
                  <div class="search-tab" data-tab="users">Users</div>
              </div>
              <div class="search-results" id="searchResults">
                  <div class="search-no-results">Enter a search term above</div>
              </div>
          </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const searchIcon = document.getElementById('searchIcon');
            const searchModal = document.getElementById('searchModal');
            const searchClose = document.getElementById('searchClose');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchTabs = document.querySelectorAll('.search-tab');
            const searchResults = document.getElementById('searchResults');
            
            // Current selected tab and search term
            let currentTab = 'games';
            let lastSearchTerm = '';
            
            // Open search modal with animation
            searchIcon.addEventListener('click', function() {
                openSearchModal();
            });
            
            // Function to open search modal
            function openSearchModal() {
                searchModal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent scrolling
                setTimeout(() => {
                    searchInput.focus();
                    
                    // If there was a previous search term, show results immediately
                    if (lastSearchTerm) {
                        searchInput.value = lastSearchTerm;
                        performSearch(lastSearchTerm);
                    }
                }, 100);
            }
            
            // Close search modal with animation
            searchClose.addEventListener('click', function() {
                closeSearchModal();
            });
            
            // Function to close search modal
            function closeSearchModal() {
                // Store the last search term
                lastSearchTerm = searchInput.value.trim();
                
                searchModal.style.opacity = '0';
                searchModal.style.transform = 'scale(0.98)';
                searchModal.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                
                setTimeout(() => {
                    searchModal.style.display = 'none';
                    searchModal.style.opacity = '';
                    searchModal.style.transform = '';
                    document.body.style.overflow = ''; // Restore scrolling
                }, 200);
            }
            
            // Close modal on outside click
            searchModal.addEventListener('click', function(e) {
                if (e.target === searchModal) {
                    closeSearchModal();
                }
            });
            
            // Global keyboard shortcut for search (press '/' to search)
            document.addEventListener('keydown', function(e) {
                // Don't trigger if already in an input field
                if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && 
                    document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault(); // Prevent typing '/' in any input field
                    openSearchModal();
                }
                
                // Escape key to close search modal
                if (e.key === 'Escape' && searchModal.style.display === 'flex') {
                    closeSearchModal();
                }
            });
            
            // Switch tabs with smooth animation
            searchTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    searchTabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Update current tab
                    currentTab = this.dataset.tab;
                    
                    // Animate the tab change
                    searchResults.style.opacity = '0';
                    searchResults.style.transform = 'translateY(10px)';
                    searchResults.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                    
                    setTimeout(() => {
                        // If there's a search term, refresh results for the new tab
                        if (searchInput.value.trim()) {
                            performSearch(searchInput.value.trim());
                        } else {
                            searchResults.innerHTML = '<div class="search-no-results">Enter a search term above</div>';
                        }
                        
                        // Fade back in
                        searchResults.style.opacity = '1';
                        searchResults.style.transform = 'translateY(0)';
                    }, 200);
                });
            });
            
            // Perform search on button click
            searchButton.addEventListener('click', function() {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    performSearch(searchTerm);
                }
            });
            
            // Perform search on Enter key
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.trim();
                    if (searchTerm) {
                        performSearch(searchTerm);
                    }
                }
            });
            
            // Search function with loading animation
            function performSearch(searchTerm) {
                // Store the search term
                lastSearchTerm = searchTerm;
                
                // Show loading state with animation
                searchResults.innerHTML = `
                    <div class="search-no-results">
                        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s infinite linear;"></div>
                        <div style="margin-top: 10px;">Searching...</div>
                    </div>
                `;
                
                if (currentTab === 'games') {
                    searchGames(searchTerm);
                } else if (currentTab === 'apps') {
                    searchApps(searchTerm);
                } else if (currentTab === 'users') {
                    searchUsers(searchTerm);
                }
            }
            
            // Add a loading animation style
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            // Search games
            function searchGames(searchTerm) {
                const searchTermLower = searchTerm.toLowerCase();
                
                // Function to check if a name matches the search term (same as in user search)
                function nameMatches(name, term) {
                    if (!name) return false;
                    
                    // Convert both to lowercase
                    const nameLower = name.toLowerCase();
                    
                    // Check if name starts with search term
                    if (nameLower.startsWith(term)) return true;
                    
                    // Check if any word in the name starts with the search term
                    const nameWords = nameLower.split(/\s+/);
                    for (const word of nameWords) {
                        if (word.startsWith(term)) return true;
                    }
                    
                    // Check if name contains the search term
                    return nameLower.includes(term);
                }
                
                // Fetch games from the games directory and filter them client-side
                fetch('/storage/js/templist.json')
                    .then(response => response.json())
                    .then(data => {
                        // Filter games based on search term with better partial matching
                        const matchingGames = data.filter(game => 
                            nameMatches(game.title, searchTermLower) || 
                            (game.description && game.description.toLowerCase().includes(searchTermLower))
                        );
                        
                        // Sort results: exact matches first, then starts with, then contains
                        matchingGames.sort((a, b) => {
                            const titleA = a.title.toLowerCase();
                            const titleB = b.title.toLowerCase();
                            
                            // Exact match gets highest priority
                            if (titleA === searchTermLower && titleB !== searchTermLower) return -1;
                            if (titleB === searchTermLower && titleA !== searchTermLower) return 1;
                            
                            // Starts with gets second priority
                            if (titleA.startsWith(searchTermLower) && !titleB.startsWith(searchTermLower)) return -1;
                            if (titleB.startsWith(searchTermLower) && !titleA.startsWith(searchTermLower)) return 1;
                            
                            // Default to alphabetical
                            return titleA.localeCompare(titleB);
                        });
                        
                        // Show results with fade-in animation
                        showResults(matchingGames, searchTerm, 'games');
                    })
                    .catch(error => {
                        console.error('Error searching games:', error);
                        searchResults.innerHTML = '<div class="search-no-results">Error fetching game data. Please try again.</div>';
                    });
            }
            
            // Search apps
            function searchApps(searchTerm) {
                const searchTermLower = searchTerm.toLowerCase();
                
                // Use the same matching function as games
                function nameMatches(name, term) {
                    if (!name) return false;
                    const nameLower = name.toLowerCase();
                    if (nameLower.startsWith(term)) return true;
                    const nameWords = nameLower.split(/\s+/);
                    for (const word of nameWords) {
                        if (word.startsWith(term)) return true;
                    }
                    return nameLower.includes(term);
                }
                
                // Fetch apps and filter
                fetch('/storage/js/applist.json')
                    .then(response => response.json())
                    .then(data => {
                        const matchingApps = data.filter(app => 
                            nameMatches(app.name, searchTermLower) || 
                            (app.description && app.description.toLowerCase().includes(searchTermLower))
                        );
                        
                        // Sort results with the same priority as games
                        matchingApps.sort((a, b) => {
                            const nameA = a.name.toLowerCase();
                            const nameB = b.name.toLowerCase();
                            
                            if (nameA === searchTermLower && nameB !== searchTermLower) return -1;
                            if (nameB === searchTermLower && nameA !== searchTermLower) return 1;
                            
                            if (nameA.startsWith(searchTermLower) && !nameB.startsWith(searchTermLower)) return -1;
                            if (nameB.startsWith(searchTermLower) && !nameA.startsWith(searchTermLower)) return 1;
                            
                            return nameA.localeCompare(nameB);
                        });
                        
                        // Show results
                        showResults(matchingApps, searchTerm, 'apps');
                    })
                    .catch(error => {
                        console.error('Error searching apps:', error);
                        searchResults.innerHTML = '<div class="search-no-results">Error fetching app data. Please try again.</div>';
                    });
            }
            
            // Search users
            function searchUsers(searchTerm) {
                const searchTermLower = searchTerm.toLowerCase();
                
                // Check if Firebase is available
                if (typeof firebase === 'undefined' || !firebase.firestore) {
                    searchResults.innerHTML = '<div class="search-no-results">Search service is currently unavailable. Please try again later.</div>';
                    return;
                }
                
                // Get the current user ID to check permissions
                const currentUserId = localStorage.getItem('userId');
                if (!currentUserId) {
                    searchResults.innerHTML = '<div class="search-no-results">You need to be logged in to search for users. <a href="login.html" style="color: var(--primary-color); text-decoration: underline;">Log in</a></div>';
                    return;
                }
                
                // Query Firestore for the current user's profile only
                firebase.firestore().collection('userProfiles').doc(currentUserId).get()
                    .then(doc => {
                        if (!doc.exists) {
                            searchResults.innerHTML = '<div class="search-no-results">Your profile is not yet set up. Please complete account setup first.</div>';
                            return;
                        }
                        
                        // Now query all user profiles
                        return firebase.firestore().collection('userProfiles')
                            .where('displayName', '>=', searchTermLower)
                            .limit(20)
                            .get();
                    })
                    .then(snapshot => {
                        if (!snapshot) return;
                        
                        // Filter users based on search term
                        const matchingUsers = [];
                        
                        snapshot.forEach(doc => {
                            const userData = doc.data();
                            const displayName = userData.displayName || '';
                            
                            // Check if display name or username contains the search term
                            if (displayName.toLowerCase().includes(searchTermLower) ||
                                (userData.username && userData.username.toLowerCase().includes(searchTermLower))) {
                                
                                // Add user to results
                                matchingUsers.push({
                                    id: doc.id,
                                    displayName: displayName,
                                    username: userData.username || displayName,
                                    avatarUrl: userData.avatarUrl || '',
                                    memberSince: userData.createdAt ? userData.createdAt.toDate().toLocaleDateString() : 'Unknown'
                                });
                            }
                        });
                        
                        // Show user results
                        showResults(matchingUsers, searchTerm, 'users');
                    })
                    .catch(error => {
                        console.error('Error searching users:', error);
                        searchResults.innerHTML = '<div class="search-no-results">Error searching users. Please try again.</div>';
                    });
            }
            
            // Function to display search results with proper formatting
            function showResults(items, searchTerm, type) {
                // Clear results with animation
                searchResults.style.opacity = '0';
                searchResults.style.transform = 'translateY(10px)';
                
                setTimeout(() => {
                    // Show no results message if needed
                    if (items.length === 0) {
                        searchResults.innerHTML = `<div class="search-no-results">No ${type} found matching "${searchTerm}"</div>`;
                        searchResults.style.opacity = '1';
                        searchResults.style.transform = 'translateY(0)';
                        return;
                    }
                    
                    // Clear previous results
                    searchResults.innerHTML = '';
                    
                    // Limit to first 20 results
                    const limitedResults = items.slice(0, 20);
                    
                    // Add each item to the results
                    if (type === 'games') {
                        limitedResults.forEach(game => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.onclick = function() {
                                window.location.href = game.link;
                            };
                            
                            resultItem.innerHTML = `
                                <img src="${game.img || '/images/other/controller.png'}" alt="${game.title}" onerror="this.src='/images/other/controller.png';">
                                <div class="search-result-info">
                                    <div class="search-result-title">${game.title}</div>
                                    <div class="search-result-description">${game.description || 'Play this game on Vexplay'}</div>
                                </div>
                            `;
                            
                            searchResults.appendChild(resultItem);
                        });
                    } else if (type === 'apps') {
                        limitedResults.forEach(app => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.onclick = function() {
                                window.location.href = app.link || `/apps/${app.id}/index.html`;
                            };
                            
                            resultItem.innerHTML = `
                                <img src="${app.img || '/images/other/apps.png'}" alt="${app.name}" onerror="this.src='/images/other/apps.png';">
                                <div class="search-result-info">
                                    <div class="search-result-title">${app.name}</div>
                                    <div class="search-result-description">${app.description || 'Try this app on Vexplay'}</div>
                                </div>
                            `;
                            
                            searchResults.appendChild(resultItem);
                        });
                    } else if (type === 'users') {
                        limitedResults.forEach(user => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.onclick = function() {
                                window.location.href = `user-profile.html?id=${user.id}`;
                            };
                            
                            // Create user avatar (image or initials)
                            let avatarHtml;
                            if (user.avatarUrl) {
                                avatarHtml = `<div class="user-result-avatar" style="background-image: url('${user.avatarUrl}');"></div>`;
                            } else {
                                const initial = user.displayName.charAt(0).toUpperCase();
                                avatarHtml = `<div class="user-result-avatar">${initial}</div>`;
                            }
                            
                            resultItem.innerHTML = `
                                ${avatarHtml}
                                <div class="search-result-info">
                                    <div class="search-result-title">${user.displayName}</div>
                                    <div class="search-result-description">Member since ${user.memberSince}</div>
                                </div>
                            `;
                            
                            searchResults.appendChild(resultItem);
                        });
                    }
                    
                    // Fade in results
                    searchResults.style.opacity = '1';
                    searchResults.style.transform = 'translateY(0)';
                }, 200);
            }
        });
      </script>
  </body>
</html>
