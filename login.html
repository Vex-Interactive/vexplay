<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Vercel Analytics and Speed Insights -->
        <script defer src="/_vercel/insights/script.js"></script>
        <script defer src="/_vercel/speed-insights/script.js"></script>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-NX2QKP76"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-7FN7LEVWXD');
        </script>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" href="/images/ico.ico" type="image/x-icon">
        <link rel="stylesheet" href="/storage/css/index.css">
        <title>Login | Vexplay</title>

        <meta name="description" content="Login to Vexplay - an open source games site hosting 500+ games, useful utilities, powerful settings + a clean user interface">
        <meta property="og:site_name" content="Vexplay">
        <meta property="og:title" content="Vexplay Login">
        <meta property="og:type" content="website">
        <meta property="og:description" content="Login to Vexplay - an open source games site hosting 500+ games, useful utilities, powerful settings + a clean user interface">
        
        <style>
            .content-side {
                min-height: 100vh;
                justify-content: flex-start;
                padding-top: 40px;
                padding-bottom: 60px;
                box-sizing: border-box;
                position: relative;
            }

            .auth-container {
                max-width: 400px;
                margin: 0 auto;
                padding: 20px;
                border: 3px solid var(--border-color2);
                border-radius: 16px;
                background-color: var(--background-color);
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-size: 16px;
            }
            
            .form-group input {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                border: 2px solid var(--border-color2);
                border-radius: 8px;
                background-color: rgba(0, 0, 0, 0.2); /* Darker background for input */
                color: var(--text-color);
                font-family: var(--font-family);
                box-sizing: border-box; /* Make sure padding doesn't affect width */
                transition: border-color 0.2s, background-color 0.2s;
            }
            
            .form-group input:focus {
                outline: none;
                border-color: var(--hover-color);
                background-color: rgba(0, 0, 0, 0.3); /* Even darker on focus */
            }
            
            /* Styling for country code select */
            .form-group select {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                border: 2px solid var(--border-color2);
                border-radius: 8px;
                background-color: rgba(0, 0, 0, 0.2);
                color: var(--text-color);
                font-family: var(--font-family);
                box-sizing: border-box;
                transition: border-color 0.2s, background-color 0.2s;
                appearance: auto; /* Keep default dropdown arrow */
            }
            
            .form-group select:focus {
                outline: none;
                border-color: var(--hover-color);
                background-color: rgba(0, 0, 0, 0.3);
            }
            
            .auth-button {
                width: 100%;
                padding: 12px;
                background-color: var(--background-color);
                color: var(--text-color);
                border: 3px solid var(--border-color2);
                border-radius: 8px;
                font-size: 16px;
                cursor: pointer;
                font-family: var(--font-family);
                margin-top: 10px;
                transition: background-color 0.15s ease-in-out;
            }
            
            .auth-button:hover {
                background-color: var(--hover-color);
            }
            
            .auth-divider {
                text-align: center;
                margin: 20px 0;
                position: relative;
            }
            
            .auth-divider::before {
                content: "";
                position: absolute;
                top: 50%;
                left: 0;
                right: 0;
                height: 1px;
                background-color: var(--border-color2);
            }
            
            .auth-divider span {
                position: relative;
                background-color: var(--background-color);
                padding: 0 10px;
                color: var(--text-color);
            }
            
            .google-button {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }
            
            .google-button img {
                width: 20px;
                height: 20px;
            }
            
            .auth-footer {
                text-align: center;
                margin-top: 20px;
            }
            
            .auth-footer a {
                color: var(--text-color);
                text-decoration: underline;
                transition: color 0.15s;
            }
            
            .auth-footer a:hover {
                color: var(--hover-color);
            }
            
            .auth-error {
                color: #ff6b6b;
                margin-top: 10px;
                margin-bottom: 15px;
                text-align: center;
                padding: 8px;
                border-radius: 8px;
                background-color: rgba(255, 107, 107, 0.1);
                display: none;
            }

            .footer-links {
                position: absolute;
                bottom: 20px;
                width: 100%;
                text-align: center;
            }
        </style>
  </head>
  <body>
      <div class="content-side">
          <h1 class="typewriter">Vexplay</h1>
          <h2>login to your account</h2>

          <div class="auth-container">
              <div id="loginError" class="auth-error"></div>
              
              <!-- Add troubleshoot button and fallback auth container that appear when network error is shown -->
              <div id="troubleshoot-container" style="display: none; margin-top: 15px;">
                  <button id="immediate-troubleshoot-button" class="auth-button">Troubleshoot Connection</button>
                  
                  <div id="fallback-auth-container" style="margin-top: 20px; padding: 15px; border: 2px dashed var(--border-color2); border-radius: 8px; background-color: rgba(0, 0, 0, 0.2);">
                      <h3 style="margin-top: 0; text-align: center;">Alternative Login Options</h3>
                      <p style="text-align: center; margin-bottom: 15px;">Firebase authentication is currently having issues. You can:</p>
                      <button id="immediate-anonymous-login" class="auth-button" style="margin-bottom: 10px;">Continue Anonymously</button>
                      <button id="immediate-offline-login" class="auth-button" style="margin-bottom: 10px;">Try Offline Login</button>
                      <button id="immediate-guest-mode" class="auth-button">Continue as Guest</button>
                  </div>
              </div>
              
              <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" id="email" placeholder="Enter your email">
              </div>
              
              <div class="form-group">
                  <label for="password">Password</label>
                  <input type="password" id="password" placeholder="Enter your password">
                  <div style="text-align: right; margin-top: 5px;">
                      <a href="#" id="forgotPasswordLink" style="font-size: 14px; text-decoration: underline;">Forgot password?</a>
                  </div>
              </div>
              
              <button class="auth-button" id="loginButton">Login</button>
              
              <div class="auth-divider">
                  <span>or</span>
              </div>
              
              <div class="auth-footer">
                  <p>Don't have an account? <a href="signup.html">Sign up</a></p>
              </div>
          </div>

          <div class="footer-links">
              <p class="linkp"><a href="index.html">back to homepage</a> • <a href="https://discord.gg/k9MH6Y875s" target="_blank">discord</a></p>
          </div>
      </div>

      <!-- Forgot Password Modal -->
      <div id="forgotPasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000;">
          <div style="background-color: var(--background-color); padding: 20px; border-radius: 16px; border: 3px solid var(--border-color2); max-width: 400px; width: 90%;">
              <h3 style="margin-top: 0;">Reset Password</h3>
              <p>Enter your email to receive a password reset link.</p>
              
              <div class="form-group">
                  <label for="resetEmail">Email</label>
                  <input type="email" id="resetEmail" placeholder="Enter your email">
              </div>
              
              <div id="resetError" style="color: #ff6b6b; margin: 10px 0; display: none;"></div>
              <div id="resetSuccess" style="color: #4BB543; margin: 10px 0; display: none;"></div>
              
              <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                  <button id="cancelResetBtn" class="auth-button" style="width: 48%;">Cancel</button>
                  <button id="sendResetBtn" class="auth-button" style="width: 48%;">Send Reset Link</button>
              </div>
          </div>
      </div>

      <!-- Add reCAPTCHA for phone auth -->
      <script src="https://www.google.com/recaptcha/api.js"></script>

      <!-- Firebase SDK -->
      <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-auth-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore-compat.js"></script>

      <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBrD_IAs4WIf4ikI-9jdwgH65gXErj8Dv8",
            authDomain: "vexplay-33e9f.firebaseapp.com",
            projectId: "vexplay-33e9f",
            storageBucket: "vexplay-33e9f.firebasestorage.app",
            messagingSenderId: "797854431681",
            appId: "1:797854431681:web:b09b88437937b9fc551740",
            measurementId: "G-KRWYW4Z4Y3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Handle login form submission
        document.getElementById('loginButton').addEventListener('click', function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Clear any previous errors
            errorDiv.style.display = 'none';
            
            // Attempt to sign in with email and password
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // User signed in successfully
                    const user = userCredential.user;
                    localStorage.setItem('userLoggedIn', 'true');
                    localStorage.setItem('userEmail', user.email);
                    localStorage.setItem('userId', user.uid);
                    localStorage.setItem('isGuest', 'false');
                    
                    // Get default display name from email (as fallback)
                    const defaultDisplayName = user.email.split('@')[0];
                    
                    // First check if we can access Firestore
                    if (typeof firebase === 'undefined' || typeof firebase.firestore !== 'function') {
                        console.warn("Firestore not available, using fallback authentication flow");
                        // Use fallback - store display name and redirect
                        localStorage.setItem('displayName', defaultDisplayName);
                    
                        // Redirect to home or the redirect URL if provided
                        const urlParams = new URLSearchParams(window.location.search);
                        const redirectUrl = urlParams.get('redirect') || '/index.html';
                        window.location.href = redirectUrl;
                        return;
                    }
                    
                    // Check if user has completed account setup
                    try {
                        firebase.firestore().collection('userProfiles').doc(user.uid).get()
                            .then((doc) => {
                                if (doc.exists) {
                                    // User profile exists in Firestore
                                    const profileData = doc.data();
                                    
                                    // Store all relevant profile data in localStorage for immediate access
                                    localStorage.setItem('displayName', profileData.displayName || profileData.username || defaultDisplayName);
                                    localStorage.setItem('avatarUrl', profileData.avatarUrl || '');
                                    
                                    // Store additional profile data if available
                                    if (profileData.bio) localStorage.setItem('userBio', profileData.bio);
                                    if (profileData.timezone) localStorage.setItem('userTimezone', profileData.timezone);
                                    if (profileData.country) localStorage.setItem('userCountry', profileData.country);
                                    
                                    // Check if setup is complete
                                    if (profileData.setupComplete) {
                                        // Update last login timestamp
                                        firebase.firestore().collection('userProfiles').doc(user.uid).update({
                                            lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                                        }).catch(error => {
                                            console.warn("Failed to update last login timestamp:", error);
                                        });
                                        
                                        // Redirect to home or the redirect URL if provided
                                        const urlParams = new URLSearchParams(window.location.search);
                                        const redirectUrl = urlParams.get('redirect');
                                        if (redirectUrl) {
                                            window.location.href = redirectUrl;
                                        } else {
                                            window.location.href = 'index.html';
                                        }
                                    } else {
                                        // User hasn't completed setup, redirect to setup page
                                        console.log("User hasn't completed account setup. Redirecting to setup page.");
                                        window.location.href = 'account-setup.html';
                                    }
                                } else {
                                    // No user profile exists, create a minimal one
                                    console.log("No user profile found in Firestore. Creating a basic profile.");
                                    const basicProfile = {
                                        userId: user.uid,
                                        email: user.email,
                                        displayName: defaultDisplayName,
                                        username: defaultDisplayName,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                                        setupComplete: false
                                    };
                                    
                                    // Save minimal profile to localStorage
                                    localStorage.setItem('displayName', defaultDisplayName);
                                    
                                    // Create the profile in Firestore
                                    firebase.firestore().collection('userProfiles').doc(user.uid).set(basicProfile)
                                        .then(() => {
                                            console.log("Basic profile created. Redirecting to account setup.");
                                            window.location.href = 'account-setup.html';
                                        })
                                        .catch(error => {
                                            console.error("Error creating basic profile:", error);
                                            // Redirect to setup page anyway
                                            window.location.href = 'account-setup.html';
                                        });
                                }
                            })
                            .catch((error) => {
                                console.error("Error checking account setup:", error);
                                // Redirect anyway to avoid being stuck on login page
                                window.location.href = 'account-setup.html';
                            });
                    } catch (error) {
                        console.error("Exception checking profile:", error);
                        // Use fallback - store display name and redirect
                        localStorage.setItem('displayName', defaultDisplayName);
                        
                        // Redirect to home as fallback
                        const urlParams = new URLSearchParams(window.location.search);
                        const redirectUrl = urlParams.get('redirect') || '/index.html';
                        window.location.href = redirectUrl;
                    }
                })
                .catch((error) => {
                    console.error("Login error:", error);
                    errorDiv.textContent = 'Login failed: ' + error.message;
                    errorDiv.style.display = 'block';
                        
                    // Show troubleshoot options for network errors
                    if (error.code === 'auth/network-request-failed') {
                        document.getElementById('troubleshoot-container').style.display = 'block';
                    }
                });
        });
                        
        // Phone authentication
        let verificationId = '';
        
        document.getElementById('sendCodeButton').addEventListener('click', function() {
            const countryCode = document.getElementById('country-code').value;
            const phoneInput = document.getElementById('phone').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!phoneInput) {
                errorDiv.textContent = 'Please enter your phone number';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Format the phone number with the country code
            const phoneNumber = countryCode + phoneInput.replace(/\D/g, '');
            
            // Show formatting in error div
            errorDiv.textContent = 'Sending code to ' + phoneNumber;
            errorDiv.style.color = '#ffffff';
            errorDiv.style.backgroundColor = 'rgba(0, 150, 255, 0.1)';
            errorDiv.style.display = 'block';
            
            // Setup reCAPTCHA verification
            const appVerifier = new firebase.auth.RecaptchaVerifier('sendCodeButton', {
                'size': 'invisible',
                'callback': function(response) {
                    // reCAPTCHA solved, allow signInWithPhoneNumber.
                    console.log('reCAPTCHA verified!');
                            }
            });
            
            // Send verification code
            firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
                .then(function (confirmationResult) {
                    // SMS sent. Save the verification ID and show the verification code input
                    verificationId = confirmationResult.verificationId;
                    document.getElementById('verificationCodeDiv').style.display = 'block';
                    document.getElementById('sendCodeButton').textContent = 'Resend Code';
                })
                .catch(function (error) {
                    console.error("Phone auth error:", error);
                    errorDiv.textContent = 'Failed to send verification code: ' + error.message;
                    errorDiv.style.display = 'block';
                    appVerifier.clear();
                });
        });

        // Verify code
        document.getElementById('verifyCodeButton').addEventListener('click', function() {
            const verificationCode = document.getElementById('verificationCode').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!verificationCode) {
                errorDiv.textContent = 'Please enter verification code';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Clear any previous errors
            errorDiv.style.display = 'none';
            
            // Create credential with verification ID and code
            const credential = firebase.auth.PhoneAuthProvider.credential(verificationId, verificationCode);
            
            // Sign in with credential
            firebase.auth().signInWithCredential(credential)
                .then((userCredential) => {
                    // User signed in successfully
                    const user = userCredential.user;
                    localStorage.setItem('userLoggedIn', 'true');
                    localStorage.setItem('userEmail', user.phoneNumber); // Store phone as identifier
                    localStorage.setItem('userId', user.uid);
                    localStorage.setItem('isGuest', 'false');
                    
                    // Redirect to home or the redirect URL if provided
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirectUrl = urlParams.get('redirect') || '/index.html';
                    window.location.href = redirectUrl;
                })
                .catch((error) => {
                    console.error("Verification error:", error);
                    errorDiv.textContent = 'Verification failed: ' + error.message;
                    errorDiv.style.display = 'block';
                });
        });

        // Guest login
        document.getElementById('immediate-guest-mode').addEventListener('click', function() {
            localStorage.setItem('userLoggedIn', 'true');
            localStorage.setItem('isGuest', 'true');
            
            // Redirect to home or the redirect URL if provided
            const urlParams = new URLSearchParams(window.location.search);
            const redirectUrl = urlParams.get('redirect') || '/index.html';
            window.location.href = redirectUrl;
        });
        
        // Password reset functionality
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const resetEmailInput = document.getElementById('resetEmail');
        const resetError = document.getElementById('resetError');
        const resetSuccess = document.getElementById('resetSuccess');
        const cancelResetBtn = document.getElementById('cancelResetBtn');
        const sendResetBtn = document.getElementById('sendResetBtn');
                    
        // Show forgot password modal
        forgotPasswordLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Pre-fill with email from login form if available
            const loginEmail = document.getElementById('email').value;
            if (loginEmail) {
                resetEmailInput.value = loginEmail;
            }
            
            forgotPasswordModal.style.display = 'flex';
        });

        // Hide modal on cancel
        cancelResetBtn.addEventListener('click', function() {
            forgotPasswordModal.style.display = 'none';
            resetError.style.display = 'none';
            resetSuccess.style.display = 'none';
        });
        
        // Send password reset email
        sendResetBtn.addEventListener('click', function() {
            const email = resetEmailInput.value;
                
            if (!email) {
                resetError.textContent = 'Please enter your email address';
                resetError.style.display = 'block';
                resetSuccess.style.display = 'none';
                    return;
                }
                
            // Clear previous messages
            resetError.style.display = 'none';
            resetSuccess.style.display = 'none';
            
            // Send password reset email
            firebase.auth().sendPasswordResetEmail(email)
                .then(() => {
                    resetSuccess.textContent = 'Password reset email sent! Check your inbox.';
                    resetSuccess.style.display = 'block';
                    
                    // Close modal after a delay
                    setTimeout(() => {
                        forgotPasswordModal.style.display = 'none';
                    }, 3000);
                })
                .catch((error) => {
                    console.error("Password reset error:", error);
                    resetError.textContent = error.message;
                    resetError.style.display = 'block';
                });
        });
        
        // Close modal when clicking outside
        forgotPasswordModal.addEventListener('click', function(e) {
            if (e.target === forgotPasswordModal) {
                forgotPasswordModal.style.display = 'none';
                resetError.style.display = 'none';
                resetSuccess.style.display = 'none';
            }
        });
      </script>

      <script>
        // Show troubleshoot options if there's a network error displayed
        function checkForNetworkError() {
            const errorElement = document.getElementById('loginError');
            const troubleshootContainer = document.getElementById('troubleshoot-container');
            
            // If error is visible and contains network connection text
            if (errorElement && 
                errorElement.style.display === "block" && 
                errorElement.textContent.includes('Network connection error')) {
                troubleshootContainer.style.display = "block";
            } else {
                troubleshootContainer.style.display = "none";
            }
        }
        
        // Check on page load and periodically
        window.addEventListener('DOMContentLoaded', () => {
            checkForNetworkError();
            
            // Setup immediate troubleshoot button
            document.getElementById('immediate-troubleshoot-button').addEventListener('click', async () => {
                const button = document.getElementById('immediate-troubleshoot-button');
                button.textContent = "Running Diagnostics...";
                button.disabled = true;
                
                try {
                    // Import the diagnostic module dynamically
                    const { runFirebaseDiagnostics } = await import('./storage/js/firebase-diagnostic.js');
                    
                    // Use the direct API key
                    const apiKey = "AIzaSyBrD_IAs4WIf4ikI-9jdwgH65gXErj8Dv8";
                    
                    // Run diagnostics
                    const results = await runFirebaseDiagnostics(apiKey);
                    
                    // Create or update diagnostic results element
                    let diagnosticResultsElem = document.getElementById('diagnostic-results');
                    if (!diagnosticResultsElem) {
                        diagnosticResultsElem = document.createElement('div');
                        diagnosticResultsElem.id = 'diagnostic-results';
                        diagnosticResultsElem.style.marginTop = '15px';
                        diagnosticResultsElem.style.textAlign = 'left';
                        diagnosticResultsElem.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                        diagnosticResultsElem.style.padding = '10px';
                        diagnosticResultsElem.style.borderRadius = '5px';
                        diagnosticResultsElem.style.fontSize = '14px';
                        diagnosticResultsElem.style.whiteSpace = 'pre-line';
                        button.parentNode.insertBefore(diagnosticResultsElem, button.nextSibling);
                    }
                    
                    // Display diagnostic results
                    diagnosticResultsElem.innerHTML = `
                        <strong>Diagnostic Results:</strong>
                        <br>
                        Browser Compatible: ${results.browserCompatible ? '✅' : '❌'}
                        <br>
                        Network Connection: ${results.googleConnectivity ? '✅' : '❌'}
                        <br>
                        Firebase SDK: ${results.firebaseSDKLoaded ? '✅' : '❌'}
                        <br>
                        Content Blockers: ${results.noContentBlockers ? '✅ None detected' : '❌ Detected'}
                        <br>
                        API Key Valid: ${results.apiKeyValid ? '✅' : '❌'}
                        <br>
                        Storage Permissions: ${results.storagePermissionsGranted ? '✅' : '❌'}
                        <br><br>
                        <strong>Recommendations:</strong>
                        <br>
                        ${results.recommendations}
                    `;
                } catch (error) {
                    console.error('Error running diagnostics:', error);
                    const errorElement = document.getElementById('loginError');
                    errorElement.textContent = `Error running diagnostics: ${error.message}`;
                } finally {
                    button.textContent = "Troubleshoot Connection";
                    button.disabled = false;
                }
            });
            
            // Setup immediate anonymous login button
            document.getElementById('immediate-anonymous-login').addEventListener('click', () => {
                const errorElement = document.getElementById('loginError');
                
                // Show loading message
                errorElement.textContent = "Connecting anonymously...";
                errorElement.style.color = "#ffffff";
                errorElement.style.backgroundColor = "rgba(0, 150, 255, 0.1)";
                errorElement.style.display = "block";
                
                signInAnonymously(auth)
                    .then((userCredential) => {
                        // Anonymous login successful
                        const user = userCredential.user;
                        localStorage.setItem('userLoggedIn', 'true');
                        localStorage.setItem('isGuest', 'true');
                        localStorage.setItem('userId', user.uid);
                        localStorage.setItem('userEmail', 'anonymous');
                        
                        errorElement.style.color = "#4BB543";
                        errorElement.style.backgroundColor = "rgba(75, 181, 67, 0.1)";
                        errorElement.textContent = "Anonymous login successful. Redirecting...";
                        
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                    })
                    .catch((error) => {
                        console.error("Anonymous login error:", error);
                        errorElement.textContent = "Anonymous login failed: " + error.message;
                        
                        // Fall back to guest mode
                        setTimeout(() => {
                            errorElement.textContent = "Falling back to guest mode...";
                            setTimeout(() => {
                                // Set guest status in localStorage without using Firebase
                                createGuestSession();
                                errorElement.style.color = "#4BB543";
                                errorElement.style.backgroundColor = "rgba(75, 181, 67, 0.1)";
                                errorElement.textContent = "Guest mode activated. Redirecting...";
                                setTimeout(() => {
                                    window.location.href = 'index.html';
                                }, 1500);
                            }, 1000);
                        }, 1500);
                    });
            });
            
            // Setup immediate offline login button
            document.getElementById('immediate-offline-login').addEventListener('click', async () => {
                try {
                    // Import the offline auth module dynamically
                    const { emergencyLogin } = await import('./storage/js/offline-auth-fallback.js');
                    
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const errorElement = document.getElementById('loginError');
                    
                    if (!email || !password) {
                        errorElement.textContent = "Please enter both email and password for offline login";
                        errorElement.style.display = "block";
                        return;
                    }
                    
                    // Try emergency login
                    const result = emergencyLogin(email, password);
                    
                    if (result.success) {
                        errorElement.style.color = "#4BB543";
                        errorElement.style.backgroundColor = "rgba(75, 181, 67, 0.1)";
                        errorElement.textContent = "Offline login successful. Redirecting...";
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                    } else {
                        errorElement.textContent = "Offline login failed. Try guest mode or wait for Firebase to be available.";
                    }
                } catch (error) {
                    console.error('Error with offline login:', error);
                    const errorElement = document.getElementById('loginError');
                    errorElement.textContent = `Error with offline login: ${error.message}`;
                }
            });
            
            // Setup immediate guest mode button
            document.getElementById('immediate-guest-mode').addEventListener('click', async () => {
                try {
                    // Import the offline auth module dynamically
                    const { createGuestSession } = await import('./storage/js/offline-auth-fallback.js');
                    
                    createGuestSession();
                    const errorElement = document.getElementById('loginError');
                    errorElement.style.color = "#4BB543";
                    errorElement.style.backgroundColor = "rgba(75, 181, 67, 0.1)";
                    errorElement.textContent = "Guest mode activated. Redirecting...";
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } catch (error) {
                    console.error('Error with guest mode:', error);
                    const errorElement = document.getElementById('loginError');
                    errorElement.textContent = `Error with guest mode: ${error.message}`;
                }
            });
            
            // Check for network errors occasionally
            setInterval(checkForNetworkError, 1000);
        });
        
        // Listen for error messages being displayed
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.target.id === 'loginError' && 
                    (mutation.attributeName === 'style' || mutation.attributeName === 'textContent')) {
                    checkForNetworkError();
                }
            });
        });
        
        // Start observing the error element
        const errorElement = document.getElementById('loginError');
        observer.observe(errorElement, { attributes: true, childList: true, subtree: true });
      </script>

      <script src="storage/js/cloak.js"></script>
      <script src="storage/js/theme.js"></script>
      <script src="storage/js/cookie.js"></script>
  </body>
</html> 